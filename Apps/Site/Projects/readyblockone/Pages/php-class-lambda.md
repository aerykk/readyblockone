<div class="post-807 post type-post status-publish format-standard hentry category-programming tag-class tag-lambda tag-php row-fluid blog-post" id="post-807">
    <div class="nav span2">
        <ul class="well nav-list">
            <li class="author">
                <i class="icon-user icon-black"></i> By: <a href="/author/eric/" title="Posts by Eric Muyser" rel="author" address="true">Eric Muyser</a> </li>
            <li class="published">
                <i class="icon-time icon-black"></i> On: <strong>May 23, 2010</strong>
            </li>
            <li class="categories">
                <i class="icon-book icon-black"></i> In: <a href="/category/programming/" title="View all posts in Programming" rel="category tag" address="true">Programming</a> </li>
            <li class="comments">
                <i class="icon-comment icon-black"></i> With <a href="/php-class-lambda/#respond" title="Comment on New Class: Lambda" address="true">no comments</a> </li>
            <li class="tags">
                <i class="icon-tags icon-black"></i> Tags: <a href="/tag/class/" rel="tag" address="true">Class</a>, <a href="/tag/lambda/" rel="tag" address="true">Lambda</a>, <a href="/tag/php/" rel="tag" address="true">PHP</a> </li>
        </ul>
    </div>
    <div class="post-thumb">
        <a title="Permanent Link to New Class: Lambda" href="/php-class-lambda/" address="true"></a>
    </div>
    <div class="span9 content">
        <p><span id="more-807"></span>
        </p>
        <p>At the moment PHP doesn’t allow serializing closures. I needed a unobtrusive solution to passing closures to child processes, which are invoked later when the child process has completed the task.</p>
        <p>I came across an informational article Jeremy Lindblom wrote on closures in&nbsp;<a href="http://php.net/" target="_blank">PHP 5</a>&nbsp;over at&nbsp;<a href="http://www.htmlist.com/development/extending-php-5-3-closures-with-serialization-and-reflection/" target="_blank">HTMList</a>&nbsp;which helped me come up with a solution to my problem. I didn’t end up needing to save the serialized closure for a different process (or HTTP request), but it looks like a very interesting solution.</p>
        <p>For my purposes I can keep references to actual closures in the main process, and they will function exactly as they should later (including&nbsp;<em><strong>use</strong></em>&nbsp;references). An example is a cron which goes through a list of videos, spawns an FFMPEG encoding process, sends a job off to it with a lambda callback. It’s all very smooth and asynchronous. Another example is a DNS checking service (since IIRC, DNS requests are not currently asynchronous in PHP).</p>
        <p>&nbsp;</p>
        <p><strong>Example:</strong>
        </p>
        <pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">$a1 </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">();</span><p></p></li><li class="L3"><p><span class="pln">$some_function_called_later</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="kwd">lambda</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="kwd">use</span><span class="pun">(&amp;</span><span class="pln">$a1</span><span class="pun">)</span></p></li><li class="L4"><p></p></li><li class="L5"><p><span class="pun">{</span></p></li><li class="L6"><p></p></li><li class="L7"><p><span class="pln">	var_dump</span><span class="pun">(</span><span class="pln">$a1</span><span class="pun">);</span><span class="pln"> </span><span class="com">// will contain "info" added later below</span></p></li><li class="L8"><p></p></li><li class="L9"><p><span class="pun">}));</span></p></li><li class="L0"><p><span class="pln">$a1</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">"info"</span><span class="pun">;</span></p></li><li class="L1"><p></p></li></ol></pre>
        <p>&nbsp;</p>
        <p><strong>Source:</strong>
        </p>
        <pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pun">&lt;?</span><span class="pln">php</span><p></p></li><li class="L3"><p><span class="kwd">class</span><span class="pln"> resource_service</span></p></li><li class="L4"><p></p></li><li class="L5"><p><span class="pun">{</span></p></li><li class="L6"><p></p></li><li class="L7"><p><span class="pln">	</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="kwd">register</span><span class="pun">(&amp;</span><span class="pln">$resource</span><span class="pun">)</span></p></li><li class="L8"><p></p></li><li class="L9"><p><span class="pln">	</span><span class="pun">{</span></p></li><li class="L0"><p></p></li><li class="L1"><p><span class="pln">		$id </span><span class="pun">=</span><span class="pln"> rand</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">32768</span><span class="pun">);</span></p></li><li class="L2"><p><span class="pln">		</span><span class="kwd">while</span><span class="pun">(</span><span class="pln">isset</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">::</span><span class="pln">$registry</span><span class="pun">[</span><span class="pln">$id</span><span class="pun">]))</span></p></li><li class="L3"><p></p></li><li class="L4"><p><span class="pln">			$id </span><span class="pun">=</span><span class="pln"> rand</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">32768</span><span class="pun">);</span></p></li><li class="L5"><p><span class="pln">		</span><span class="kwd">self</span><span class="pun">::</span><span class="pln">$registry</span><span class="pun">[</span><span class="pln">$id</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">$resource</span><span class="pun">;</span></p></li><li class="L6"><p><span class="pln">		</span><span class="kwd">return</span><span class="pln"> $id</span><span class="pun">;</span></p></li><li class="L7"><p></p></li><li class="L8"><p><span class="pln">	</span><span class="pun">}</span></p></li><li class="L9"><p><span class="pln">	</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> unregister</span><span class="pun">(</span><span class="pln">$id</span><span class="pun">)</span></p></li><li class="L0"><p></p></li><li class="L1"><p><span class="pln">	</span><span class="pun">{</span></p></li><li class="L2"><p></p></li><li class="L3"><p><span class="pln">		$resource </span><span class="pun">=</span><span class="pln"> </span><span class="pun">&amp;</span><span class="kwd">self</span><span class="pun">::</span><span class="pln">$registry</span><span class="pun">[</span><span class="pln">$id</span><span class="pun">];</span></p></li><li class="L4"><p><span class="pln">		unset</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">::</span><span class="pln">$registry</span><span class="pun">[</span><span class="pln">$id</span><span class="pun">]);</span></p></li><li class="L5"><p><span class="pln">		</span><span class="kwd">return</span><span class="pln"> $resource</span><span class="pun">;</span></p></li><li class="L6"><p></p></li><li class="L7"><p><span class="pln">	</span><span class="pun">}</span></p></li><li class="L8"><p><span class="pln">	</span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> $registry</span><span class="pun">;</span></p></li><li class="L9"><p></p></li><li class="L0"><p><span class="pun">}</span></p></li><li class="L1"><p><span class="kwd">class</span><span class="pln"> </span><span class="kwd">lambda</span></p></li><li class="L2"><p></p></li><li class="L3"><p><span class="pun">{</span></p></li><li class="L4"><p></p></li><li class="L5"><p><span class="pln">	</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> __construct</span><span class="pun">(</span><span class="typ">Closure</span><span class="pln"> $closure</span><span class="pun">)</span></p></li><li class="L6"><p></p></li><li class="L7"><p><span class="pln">	</span><span class="pun">{</span></p></li><li class="L8"><p></p></li><li class="L9"><p><span class="pln">		$this</span><span class="pun">-&gt;</span><span class="pln">closure </span><span class="pun">=</span><span class="pln"> $closure</span><span class="pun">;</span></p></li><li class="L0"><p></p></li><li class="L1"><p><span class="pln">	</span><span class="pun">}</span></p></li><li class="L2"><p><span class="pln">	</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> __invoke</span><span class="pun">()</span></p></li><li class="L3"><p></p></li><li class="L4"><p><span class="pln">	</span><span class="pun">{</span></p></li><li class="L5"><p></p></li><li class="L6"><p><span class="pln">		</span><span class="kwd">return</span><span class="pln"> call_user_func_array</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">closure</span><span class="pun">,</span><span class="pln"> func_get_args</span><span class="pun">());</span></p></li><li class="L7"><p></p></li><li class="L8"><p><span class="pln">	</span><span class="pun">}</span></p></li><li class="L9"><p><span class="pln">	</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> __sleep</span><span class="pun">()</span></p></li><li class="L0"><p></p></li><li class="L1"><p><span class="pln">	</span><span class="pun">{</span></p></li><li class="L2"><p></p></li><li class="L3"><p><span class="pln">		$this</span><span class="pun">-&gt;</span><span class="pln">resource_id </span><span class="pun">=</span><span class="pln"> resource_service</span><span class="pun">::</span><span class="kwd">register</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">closure</span><span class="pun">);</span></p></li><li class="L4"><p><span class="pln">		</span><span class="kwd">return</span><span class="pln"> array</span><span class="pun">(</span><span class="str">"resource_id"</span><span class="pun">);</span></p></li><li class="L5"><p></p></li><li class="L6"><p><span class="pln">	</span><span class="pun">}</span></p></li><li class="L7"><p><span class="pln">	</span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> __wakeup</span><span class="pun">()</span></p></li><li class="L8"><p></p></li><li class="L9"><p><span class="pln">	</span><span class="pun">{</span></p></li><li class="L0"><p></p></li><li class="L1"><p><span class="pln">		$this</span><span class="pun">-&gt;</span><span class="pln">closure </span><span class="pun">=</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">resource_service</span><span class="pun">::</span><span class="pln">unregister</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">resource_id</span><span class="pun">);</span></p></li><li class="L2"><p></p></li><li class="L3"><p><span class="pln">	</span><span class="pun">}</span></p></li><li class="L4"><p><span class="pln">	</span><span class="kwd">private</span><span class="pln"> $closure</span><span class="pun">;</span></p></li><li class="L5"><p></p></li><li class="L6"><p><span class="pun">}</span></p></li><li class="L7"><p><span class="pun">?&gt;</span></p></li><li class="L8"><p></p></li></ol></pre>
        <p>&nbsp;</p>
        <p>More found on the&nbsp;<a href="/work/" address="true">work</a>&nbsp;page, and more to come!</p>
    </div>
</div>
<ul class="pager">
    <li class="previous">
        <a href="/php-class-curl/" rel="prev" address="true">← New Class: cURL</a> </li>
    <li class="next">
        <a href="/php-class-process/" rel="next" address="true">New Class: Process →</a> </li>
</ul>
